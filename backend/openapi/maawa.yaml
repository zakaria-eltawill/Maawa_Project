openapi: 3.1.0
info:
  title: Maawa API
  version: "1.0.0"
  description: |
    Mobile API for Maawa (Libya property rental marketplace).
    Auth: JWT access tokens (15m) + rotating Refresh Tokens (30d).
    Admin Blade uses session/CSRF (not covered here).

servers:
  - url: https://api.maawa.example/v1
    description: Production
  - url: http://localhost:8000/v1
    description: Local

security:
  - bearerAuth: []

paths:

  ########################
  # Auth (JWT)
  ########################
  /auth/register:
    post:
      tags: [Auth]
      summary: Register a new user (tenant/owner)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AuthRegisterRequest' }
      responses:
        "201":
          description: Registered
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuthRegisterResponse' }
        "422": { $ref: '#/components/responses/ValidationError' }
        "409": { $ref: '#/components/responses/Conflict' }
      security: []  # public

  /auth/login:
    post:
      tags: [Auth]
      summary: Login and receive access & refresh tokens
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AuthLoginRequest' }
      responses:
        "200":
          description: Tokens issued
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuthLoginResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "422": { $ref: '#/components/responses/ValidationError' }
      security: []  # public

  /auth/refresh:
    post:
      tags: [Auth]
      summary: Exchange refresh_token for a new access token (rotating)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AuthRefreshRequest' }
      responses:
        "200":
          description: Refreshed
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AuthRefreshResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "409": { $ref: '#/components/responses/Conflict' }
        "422": { $ref: '#/components/responses/ValidationError' }
      security: []  # public

  /auth/logout:
    post:
      tags: [Auth]
      summary: Logout (revoke current refresh token or all)
      requestBody:
        required: false
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AuthLogoutRequest' }
      responses:
        "204": { description: Logged out }
        "401": { $ref: '#/components/responses/Unauthorized' }

  /me:
    get:
      tags: [Auth]
      summary: Get current user profile
      responses:
        "200":
          description: Current user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/MeResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
    put:
      tags: [Auth]
      summary: Update current user profile
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProfileUpdateRequest' }
      responses:
        "200":
          description: Profile updated
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserResource' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "422": { $ref: '#/components/responses/ValidationError' }

  ########################
  # Properties
  ########################
  /properties:
    get:
      tags: [Properties]
      summary: Get properties (Tenant: explore all | Owner: only their properties | Admin: all properties)
      description: |
        **Role-based access:**
        - **Tenant:** Can explore all properties (full browse mode)
        - **Owner:** Can only see their own properties (management mode)
        - **Admin:** Can see all properties with full management access
      parameters:
        - $ref: '#/components/parameters/City'
        - $ref: '#/components/parameters/Type'
        - $ref: '#/components/parameters/MinPrice'
        - $ref: '#/components/parameters/MaxPrice'
        - $ref: '#/components/parameters/AvailableFrom'
        - $ref: '#/components/parameters/AvailableTo'
        - $ref: '#/components/parameters/Sort'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/PerPage'
      responses:
        "200":
          description: Paginated property list
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PropertyListResponse' }

  /properties/{id}:
    get:
      tags: [Properties]
      summary: Get a property by ID
      description: |
        Returns property details. Response format depends on user role:
        - **Owner viewing their own property:** Returns PropertyOwnerResponse with owner info and statistics
        - **Tenant/Admin:** Returns PropertyDetailResponse with basic owner info
      parameters:
        - $ref: '#/components/parameters/Id'
      responses:
        "200":
          description: Property details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PropertyDetailResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "404": { $ref: '#/components/responses/NotFound' }

  /owner/properties:
    get:
      tags: [Properties]
      summary: Get owner's properties
      description: |
        **Owner-specific endpoint** - Returns all properties owned by the authenticated owner.
        
        **Access:** Only owners can access this endpoint (403 Forbidden for tenants/admins)
        
        **Response includes:**
        - Full property details with all photos (handles both string URLs and array format)
        - Statistics (bookings_count, reviews_count, avg_rating, total_revenue)
        - Version number for conflict prevention
        - Note: Owner information is not included (owner already knows their own info)
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/City'
        - $ref: '#/components/parameters/Type'
        - $ref: '#/components/parameters/MinPrice'
        - $ref: '#/components/parameters/MaxPrice'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/PerPage'
      responses:
        "200":
          description: Owner's properties
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/PropertyOwnerResponse' }
                  next_cursor:
                    type: string
                    nullable: true
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }

  /owner/properties/{id}:
    get:
      tags: [Properties]
      summary: Get owner's property by ID
      description: |
        **Owner-specific endpoint** - Returns detailed information about a specific property owned by the authenticated owner.
        
        **Access:** Only owners can access this endpoint (403 Forbidden for tenants/admins)
        **Authorization:** Owner can only access their own properties (403 if property belongs to another owner)
        
        **Response includes:**
        - Full property details with all photos (handles both string URLs and array format)
        - Statistics (bookings_count, reviews_count, avg_rating, total_revenue)
        - Version number for conflict prevention
        - Note: Owner information is not included (owner already knows their own info)
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/Id'
      responses:
        "200":
          description: Owner's property details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PropertyOwnerResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "404": { $ref: '#/components/responses/NotFound' }
    put:
      tags: [Properties]
      summary: Create edit proposal for owner's property
      description: |
        **Owner-specific endpoint** - Creates an EDIT proposal for a property owned by the authenticated owner.
        
        **Workflow:**
        1. Owner submits property changes
        2. System creates a PENDING proposal
        3. Admin reviews and approves/rejects
        4. If approved, property is updated with new information
        5. Property appears in owner's properties list with updated data
        
        **Access:** Only owners can access this endpoint (403 Forbidden for tenants/admins)
        **Authorization:** Owner can only create proposals for their own properties (403 if property belongs to another owner)
        
        **Proposal Rules:**
        - All fields are optional (partial updates supported)
        - Version must match current property version (for conflict prevention)
        - Photos must be valid URLs (from /v1/upload endpoint)
        - Location can be updated with latitude/longitude or map_url
        - Proposal status starts as PENDING, requires admin approval
        
        **Response:** Returns proposal ID and status (PENDING)
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/Id'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PropertyUpdateRequest' }
      responses:
        "201":
          description: Edit proposal created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                    description: Proposal ID
                  status:
                    type: string
                    enum: [PENDING]
                    description: Proposal status (always PENDING when created)
                  message:
                    type: string
                    example: "Edit proposal created. Waiting for admin approval."
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "404": { $ref: '#/components/responses/NotFound' }
        "422": { $ref: '#/components/responses/ValidationError' }

  /properties/{id}/reviews:
    get:
      tags: [Reviews]
      summary: List reviews for a property
      parameters:
        - $ref: '#/components/parameters/Id'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/PerPage'
      responses:
        "200":
          description: Reviews list
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ReviewListResponse' }
        "404": { $ref: '#/components/responses/NotFound' }

  ########################
  # Bookings
  ########################
  /bookings:
    get:
      tags: [Bookings]
      summary: Get bookings (Tenant: own bookings | Owner: bookings on owned properties | Admin: all bookings)
      description: |
        **General endpoint with role-based access.**
        
        **Note:** For role-specific endpoints, use:
        - `/v1/owner/bookings` - Owner-specific endpoint (only owners)
        - `/v1/tenant/bookings` - Tenant-specific endpoint (only tenants)
        
        **Role-based access:**
        - **Tenant:** Returns only bookings created by the tenant
        - **Owner:** Returns all bookings made on properties owned by the owner
        - **Admin:** Returns all bookings with complete information (full management access)
        
        **Response includes:**
        - Booking details (id, check_in, check_out, guests, total, status)
        - Nested property details (id, title, type, city, price, thumbnail)
        - Nested tenant details (id, name, email, phone_number, region)
      parameters:
        - $ref: '#/components/parameters/BookingStatus'
        - $ref: '#/components/parameters/FromDate'
        - $ref: '#/components/parameters/ToDate'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/PerPage'
      responses:
        "200":
          description: Bookings list
          content:
            application/json:
              schema: { $ref: '#/components/schemas/BookingListResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
    post:
      tags: [Bookings]
      summary: Create booking (PENDING)
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/BookingCreateRequest' }
      responses:
        "201":
          description: Booking created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/BookingCreateResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "409": { $ref: '#/components/responses/Conflict' }
        "422": { $ref: '#/components/responses/ValidationError' }

  /owner/bookings:
    get:
      tags: [Bookings]
      summary: Get bookings for owner's properties
      description: |
        **Owner-specific endpoint** - Returns all bookings made on properties owned by the authenticated owner.
        
        **Access:** Only owners can access this endpoint (403 Forbidden for tenants/admins)
        
        **Response includes:**
        - Booking details (id, check_in, check_out, guests, total, status)
        - Nested property details (id, title, type, owner_id)
        - Nested tenant details (id, name, phone_number)
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/BookingStatus'
        - $ref: '#/components/parameters/FromDate'
        - $ref: '#/components/parameters/ToDate'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/PerPage'
      responses:
        "200":
          description: Owner's property bookings
          content:
            application/json:
              schema: { $ref: '#/components/schemas/BookingListResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }

  /owner/bookings/{status}:
    get:
      tags: [Bookings]
      summary: Get owner bookings by status
      description: |
        **Owner-specific endpoint** - Returns bookings with a specific status on properties owned by the authenticated owner.
        
        **Access:** Only owners can access this endpoint (403 Forbidden for tenants/admins)
        
        **Valid Status Values:**
        - `pending` - Bookings awaiting owner decision
        - `accepted` - Bookings accepted by owner
        - `confirmed` - Bookings with confirmed payment
        - `rejected` - Bookings rejected by owner
        - `canceled` - Canceled bookings
        - `expired` - Expired bookings
        - `completed` - Completed bookings
        - `failed` - Failed payment bookings
        
        **Response includes:**
        - Booking details (id, check_in, check_out, guests, total, status)
        - Nested property details (id, title, type, owner_id)
        - Nested tenant details (id, name, phone_number)
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: path
          required: true
          schema:
            type: string
            enum: [pending, accepted, confirmed, rejected, canceled, expired, completed, failed]
          description: Booking status (case-insensitive)
        - $ref: '#/components/parameters/FromDate'
        - $ref: '#/components/parameters/ToDate'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/PerPage'
      responses:
        "200":
          description: Owner's property bookings by status
          content:
            application/json:
              schema: { $ref: '#/components/schemas/BookingListResponse' }
        "400":
          description: Invalid status value
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }

  /tenant/bookings:
    get:
      tags: [Bookings]
      summary: Get bookings for tenant
      description: |
        **Tenant-specific endpoint** - Returns all bookings created by the authenticated tenant.
        
        **Access:** Only tenants can access this endpoint (403 Forbidden for owners/admins)
        
        **Response includes:**
        - Booking details (id, check_in, check_out, guests, total, status)
        - Nested property details (id, title, type, owner_id)
        - Nested tenant details (id, name, phone_number)
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/BookingStatus'
        - $ref: '#/components/parameters/FromDate'
        - $ref: '#/components/parameters/ToDate'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/PerPage'
      responses:
        "200":
          description: Tenant's bookings
          content:
            application/json:
              schema: { $ref: '#/components/schemas/BookingListResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }

  /tenant/bookings/{status}:
    get:
      tags: [Bookings]
      summary: Get tenant bookings by status
      description: |
        **Tenant-specific endpoint** - Returns bookings with a specific status created by the authenticated tenant.
        
        **Access:** Only tenants can access this endpoint (403 Forbidden for owners/admins)
        
        **Valid Status Values:**
        - `pending` - Bookings awaiting owner decision
        - `accepted` - Bookings accepted by owner
        - `confirmed` - Bookings with confirmed payment
        - `rejected` - Bookings rejected by owner
        - `canceled` - Canceled bookings
        - `expired` - Expired bookings
        - `completed` - Completed bookings
        - `failed` - Failed payment bookings
        
        **Response includes:**
        - Booking details (id, check_in, check_out, guests, total, status)
        - Nested property details (id, title, type, owner_id)
        - Nested tenant details (id, name, phone_number)
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: path
          required: true
          schema:
            type: string
            enum: [pending, accepted, confirmed, rejected, canceled, expired, completed, failed]
          description: Booking status (case-insensitive)
        - $ref: '#/components/parameters/FromDate'
        - $ref: '#/components/parameters/ToDate'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/PerPage'
      responses:
        "200":
          description: Tenant's bookings by status
          content:
            application/json:
              schema: { $ref: '#/components/schemas/BookingListResponse' }
        "400":
          description: Invalid status value
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }

  /owner/bookings/{id}/decision:
    post:
      tags: [Bookings]
      summary: Owner decision (ACCEPT/REJECT)
      parameters:
        - $ref: '#/components/parameters/Id'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/OwnerDecisionRequest' }
      responses:
        "200":
          description: Decision applied
          content:
            application/json:
              schema: { $ref: '#/components/schemas/OwnerDecisionResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "409": { $ref: '#/components/responses/Conflict' }
        "422": { $ref: '#/components/responses/ValidationError' }

  ########################
  # Payments (Mock)
  ########################
  /payments/mock:
    post:
      tags: [Payments]
      summary: Mock payment to confirm booking
      parameters:
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/MockPaymentRequest' }
      responses:
        "200":
          description: Booking confirmed
          content:
            application/json:
              schema: { $ref: '#/components/schemas/MockPaymentResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "409": { $ref: '#/components/responses/Conflict' }
        "410": { $ref: '#/components/responses/Gone' }
        "422": { $ref: '#/components/responses/ValidationError' }

  ########################
  # Moderation (Proposals)
  ########################
  /proposals:
    post:
      tags: [Moderation]
      summary: Create owner proposal (ADD/EDIT/DELETE)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProposalCreateRequest' }
      responses:
        "201":
          description: Proposal created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ProposalCreateResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "409": { $ref: '#/components/responses/Conflict' }
        "422": { $ref: '#/components/responses/ValidationError' }

  /owner/proposals:
    get:
      tags: [Moderation]
      summary: List proposals for current owner
      parameters:
        - $ref: '#/components/parameters/ProposalStatus'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/PerPage'
      responses:
        "200":
          description: Proposals list
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ProposalListResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }

  /owner/proposals/{id}:
    get:
      tags: [Moderation]
      summary: Get owner's proposal by ID
      description: |
        **Owner-specific endpoint** - Get a single proposal owned by the authenticated owner.
        
        **Access:** Only owners can access (403 Forbidden for tenants/admins)
        **Authorization:** Owner can only view their own proposals (404 if proposal belongs to another owner)
        
        **Response includes:**
        - Full proposal details (id, type, status, payload, version, reason, etc.)
        - All proposal data including payload structure based on type (ADD/EDIT/DELETE)
        - Timestamps (created_at, updated_at, applied_at)
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/Id'
      responses:
        "200":
          description: Proposal details
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Proposal' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "404": { $ref: '#/components/responses/NotFound' }
    put:
      tags: [Moderation]
      summary: Update owner's proposal
      description: |
        **Owner-specific endpoint** - Update a proposal owned by the authenticated owner.
        
        **Update Rules:**
        - Only PENDING or REJECTED proposals can be updated
        - Owner can only update their own proposals
        - Status automatically becomes PENDING after update
        - All fields are optional (partial updates supported)
        - Proposal type cannot be changed
        
        **Response:** Returns updated proposal with PENDING status
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/Id'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProposalUpdateRequest' }
      responses:
        "200":
          description: Proposal updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id: { type: string, format: uuid }
                  status: { type: string, enum: [PENDING] }
                  message: { type: string, example: "Proposal updated successfully. Status changed to PENDING." }
        "400":
          description: Bad Request - Proposal cannot be updated
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
              example:
                type: "about:blank"
                title: "Bad Request"
                status: 400
                detail: "Only PENDING or REJECTED proposals can be updated"
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "404": { $ref: '#/components/responses/NotFound' }
        "422": { $ref: '#/components/responses/ValidationError' }
    delete:
      tags: [Moderation]
      summary: Delete owner's proposal
      description: |
        **Owner-specific endpoint** - Delete a proposal owned by the authenticated owner.
        
        **Delete Rules:**
        - Only PENDING or REJECTED proposals can be deleted
        - Owner can only delete their own proposals
        - Hard delete from database (permanently removed)
        
        **Response:** Returns success message
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/Id'
      responses:
        "200":
          description: Proposal deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string, example: "Proposal deleted successfully" }
        "400":
          description: Bad Request - Proposal cannot be deleted
          content:
            application/problem+json:
              schema: { $ref: '#/components/schemas/Problem' }
              example:
                type: "about:blank"
                title: "Bad Request"
                status: 400
                detail: "Only PENDING or REJECTED proposals can be deleted"
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "404": { $ref: '#/components/responses/NotFound' }

  /admin/proposals:
    get:
      tags: [Admin]
      summary: Admin moderation queue
      parameters:
        - $ref: '#/components/parameters/ProposalStatus'
        - $ref: '#/components/parameters/OwnerId'
        - $ref: '#/components/parameters/FromDate'
        - $ref: '#/components/parameters/ToDate'
        - $ref: '#/components/parameters/Cursor'
        - $ref: '#/components/parameters/PerPage'
      responses:
        "200":
          description: Moderation queue
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ProposalListAdminResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }

  /admin/proposals/{id}/review:
    post:
      tags: [Admin]
      summary: Review proposal (APPROVED/REJECTED)
      parameters:
        - $ref: '#/components/parameters/Id'
        - $ref: '#/components/parameters/IdempotencyKey'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ProposalReviewRequest' }
      responses:
        "200":
          description: Review result
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ProposalReviewResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "409": { $ref: '#/components/responses/Conflict' }
        "422": { $ref: '#/components/responses/ValidationError' }

  /admin/users:
    get:
      tags: [Admin]
      summary: List users (admin)
      parameters:
        - name: role
          in: query
          schema: { type: string, enum: [tenant, owner, admin] }
        - name: email
          in: query
          schema: { type: string }
        - $ref: '#/components/parameters/FromDate'
        - $ref: '#/components/parameters/ToDate'
        - $ref: '#/components/parameters/PerPage'
      responses:
        "200":
          description: Users list
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/UserAdmin' }
                  next_cursor: { type: string, nullable: true }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }

  /admin/users/{id}:
    patch:
      tags: [Admin]
      summary: Update user role
      parameters:
        - $ref: '#/components/parameters/Id'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role]
              properties:
                role: { type: string, enum: [tenant, owner, admin] }
      responses:
        "200":
          description: Updated user
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserAdmin' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "409": { $ref: '#/components/responses/Conflict' }
        "422": { $ref: '#/components/responses/ValidationError' }
    delete:
      tags: [Admin]
      summary: Delete a user
      parameters:
        - $ref: '#/components/parameters/Id'
      responses:
        "204": { description: Deleted }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "409": { $ref: '#/components/responses/Conflict' }

  ########################
  # Reviews
  ########################
  /properties/{id}/reviews:
    post:
      tags: [Reviews]
      summary: Create a review (tenant after COMPLETED stay)
      parameters:
        - $ref: '#/components/parameters/Id'
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/ReviewCreateRequest' }
      responses:
        "201":
          description: Review created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ReviewCreateResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }
        "403": { $ref: '#/components/responses/Forbidden' }
        "422": { $ref: '#/components/responses/ValidationError' }

  ########################
  # Device Tokens (FCM)
  ########################
  /me/fcm-tokens:
    post:
      tags: [Notifications]
      summary: Add device FCM token
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FcmTokenStoreRequest' }
      responses:
        "201":
          description: Stored
          content:
            application/json:
              schema: { $ref: '#/components/schemas/FcmTokenStoreResponse' }
        "401": { $ref: '#/components/responses/Unauthorized' }

  /me/fcm-tokens/{token}:
    delete:
      tags: [Notifications]
      summary: Remove device FCM token
      parameters:
        - name: token
          in: path
          required: true
          schema: { type: string, maxLength: 255 }
      responses:
        "204": { description: Removed }
        "401": { $ref: '#/components/responses/Unauthorized' }

  ########################
  # File Upload
  ########################
  /upload:
    post:
      tags: [Files]
      summary: Upload an image file
      description: |
        Upload an image file (JPEG, PNG, WebP) and receive a public URL.
        
        **Use Cases:**
        - Property photos for proposals
        - Property listing images
        - User profile pictures
        
        **File Requirements:**
        - Allowed types: JPEG, JPG, PNG, WebP
        - Maximum size: 10MB
        - Must be a valid image file
        
        **Storage:**
        - Files are stored in organized folders based on the `folder` parameter
        - Files are publicly accessible via the returned URL
        - Unique filenames are generated to prevent conflicts
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required: [file]
              properties:
                file:
                  type: string
                  format: binary
                  description: Image file to upload (JPEG, PNG, or WebP)
                folder:
                  type: string
                  maxLength: 50
                  description: Folder name to organize uploads (e.g., "proposals", "properties", "profiles")
                  example: "proposals"
      responses:
        "201":
          description: Image uploaded successfully
          content:
            application/json:
              schema: { $ref: '#/components/schemas/FileUploadResponse' }
              examples:
                simple:
                  summary: Simple response
                  value:
                    url: "https://api.maawa.example/storage/proposals/1234567890_abc123_my-image.jpg"
                extended:
                  summary: Extended response
                  value:
                    url: "https://api.maawa.example/storage/proposals/1234567890_abc123_my-image.jpg"
                    id: "1234567890_abc123_my-image"
                    filename: "my-image.jpg"
        "400":
          description: Bad Request - Invalid file format or missing file
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
              examples:
                invalid_format:
                  summary: Invalid file format
                  value:
                    message: "Invalid file format. Only JPEG, PNG, and WebP images are allowed."
                    errors:
                      file: ["The file must be an image."]
                missing_file:
                  summary: Missing file
                  value:
                    message: "The given data was invalid."
                    errors:
                      file: ["The file field is required."]
        "401": { $ref: '#/components/responses/Unauthorized' }
        "413":
          description: Payload Too Large - File size exceeds maximum allowed
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ValidationError' }
              example:
                message: "File size exceeds maximum allowed size of 10MB."
                errors:
                  file: ["The file may not be greater than 10240 kilobytes."]
        "422": { $ref: '#/components/responses/ValidationError' }

components:

  ########################
  # Security
  ########################
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: >
        Bearer access JWT. TTL 15 minutes. Refresh via /auth/refresh using opaque rotating refresh_token.

  ########################
  # Parameters
  ########################
  parameters:
    Id:
      name: id
      in: path
      required: true
      schema: { type: string, format: uuid }

    City:
      name: city
      in: query
      schema: { type: string, maxLength: 80 }

    Type:
      name: type
      in: query
      schema:
        type: string
        enum: [apartment, villa, chalet]

    MinPrice:
      name: min_price
      in: query
      schema: { type: number, format: float, minimum: 0 }

    MaxPrice:
      name: max_price
      in: query
      schema: { type: number, format: float, minimum: 0 }

    AvailableFrom:
      name: available_from
      in: query
      schema: { type: string, format: date }

    AvailableTo:
      name: available_to
      in: query
      schema: { type: string, format: date }

    Cursor:
      name: cursor
      in: query
      schema: { type: string }

    PerPage:
      name: per_page
      in: query
      schema: { type: integer, minimum: 1, maximum: 50, default: 20 }

    Sort:
      name: sort
      in: query
      schema:
        type: string
        description: Comma-separated fields. Prefix with '-' for desc.
        example: "-price,city"

    BookingStatus:
      name: status
      in: query
      schema:
        type: string
        enum: [PENDING, ACCEPTED, CONFIRMED, REJECTED, CANCELED, EXPIRED, COMPLETED]

    FromDate:
      name: from
      in: query
      schema: { type: string, format: date }

    ToDate:
      name: to
      in: query
      schema: { type: string, format: date }

    ProposalStatus:
      name: status
      in: query
      schema:
        type: string
        enum: [PENDING, APPROVED, REJECTED]

    OwnerId:
      name: owner_id
      in: query
      schema: { type: string, format: uuid }

    IdempotencyKey:
      name: X-Idempotency-Key
      in: header
      required: true
      schema: { type: string, minLength: 8, maxLength: 128 }

  ########################
  # Common Schemas
  ########################
  schemas:

    Problem:
      type: object
      properties:
        type: { type: string }
        title: { type: string }
        status: { type: integer }
        detail: { type: string }
        errors:
          type: object
          additionalProperties:
            type: array
            items: { type: string }

    CursorMeta:
      type: object
      properties:
        next_cursor: { type: string, nullable: true }
        prev_cursor: { type: string, nullable: true }

    User:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        email: { type: string, format: email }
        phone_number: { type: string }
        region: { type: string }
        role:
          type: string
          enum: [tenant, owner, admin]

    UserAdmin:
      allOf:
        - $ref: '#/components/schemas/User'
        - type: object
          properties:
            created_at: { type: string, format: date-time }

    PropertySummary:
      type: object
      properties:
        id: { type: string, format: uuid }
        title: { type: string }
        city: { type: string }
        type:
          type: string
          enum: [apartment, villa, chalet]
        price: { type: number, format: float }
        thumbnail: { type: string }
        avg_rating: { type: number, format: float, nullable: true }

    PropertyDetail:
      allOf:
        - $ref: '#/components/schemas/PropertySummary'
        - type: object
          properties:
            description: { type: string }
            amenities:
              type: array
              items: { type: string }
            photos:
              type: array
              items:
                type: object
                properties:
                  url: { type: string }
                  position: { type: integer }
            owner:
              type: object
              nullable: true
              properties:
                id: { type: string, format: uuid }
                name: { type: string }
                phone_number: { type: string }
                email: { type: string, format: email }
                region: { type: string }
            availability:
              type: object
              properties:
                unavailable_dates:
                  type: array
                  items: { type: string, format: date }
            location:
              type: object
              properties:
                latitude: { type: number, format: float, example: 32.115 }
                longitude: { type: number, format: float, example: 20.067 }
                map_url: { type: string, example: "https://www.google.com/maps?q=32.115,20.067" }
            reviews_count: { type: integer }

    Booking:
      type: object
      properties:
        id: { type: string, format: uuid }
        property_id: { type: string, format: uuid }
        tenant_id: { type: string, format: uuid }
        check_in: { type: string, format: date }
        check_out: { type: string, format: date }
        guests: { type: integer }
        total: { type: number, format: float }
        status:
          type: string
          enum: [PENDING, ACCEPTED, CONFIRMED, REJECTED, CANCELED, EXPIRED, COMPLETED]
        payment_due_at: { type: string, format: date-time, nullable: true }
        property:
          type: object
          properties:
            id: { type: string, format: uuid }
            title: { type: string }
            type: { type: string, enum: [apartment, villa, chalet] }
            city: { type: string }
            price: { type: number, format: float }
            thumbnail: { type: string }
        tenant:
          type: object
          properties:
            id: { type: string, format: uuid }
            name: { type: string }
            email: { type: string, format: email }
            phone_number: { type: string }
            region: { type: string }

    Proposal:
      type: object
      properties:
        id: { type: string, format: uuid }
        owner_id: { type: string, format: uuid }
        property_id: { type: string, format: uuid, nullable: true }
        type:
          type: string
          enum: [ADD, EDIT, DELETE]
        status:
          type: string
          enum: [PENDING, APPROVED, REJECTED]
        notes: { type: string, nullable: true }
        payload:
          type: object
          description: "For ADD: full property; for EDIT: diff fields; for DELETE: reason captured separately."
        version: { type: integer, nullable: true }
        reason: { type: string, nullable: true }
        applied_at: { type: string, format: date-time, nullable: true }
        created_at: { type: string, format: date-time }
        updated_at: { type: string, format: date-time }

    Review:
      type: object
      properties:
        id: { type: string, format: uuid }
        booking_id: { type: string, format: uuid }
        property_id: { type: string, format: uuid }
        tenant_id: { type: string, format: uuid }
        rating: { type: integer, minimum: 1, maximum: 5 }
        comment: { type: string, maxLength: 500 }

    ########################
    # Request/Response Schemas
    ########################

    # Auth
    AuthRegisterRequest:
      type: object
      required: [name, email, password, password_confirmation, role, phone_number, region]
      properties:
        name: { type: string, minLength: 2, maxLength: 80 }
        email: { type: string, format: email }
        password: { type: string, minLength: 8 }
        password_confirmation: { type: string, minLength: 8 }
        role:
          type: string
          enum: [tenant, owner]
        phone_number:
          type: string
          pattern: '^09[0-9]{8}$'
          description: 'Libyan mobile number (10 digits starting with 09)'
          example: "0912345678"
        region:
          type: string
          maxLength: 100
          example: "Benghazi"

    AuthRegisterResponse:
      type: object
      properties:
        user: { $ref: '#/components/schemas/User' }
        access_token: { type: string }
        token_type: { type: string, example: Bearer }
        expires_in: { type: integer, example: 900 }
        refresh_token: { type: string }

    AuthLoginRequest:
      type: object
      required: [email, password]
      properties:
        email: { type: string, format: email }
        password: { type: string, minLength: 8 }

    AuthLoginResponse:
      allOf:
        - $ref: '#/components/schemas/AuthRegisterResponse'

    AuthRefreshRequest:
      type: object
      required: [refresh_token]
      properties:
        refresh_token: { type: string }

    AuthRefreshResponse:
      type: object
      properties:
        access_token: { type: string }
        token_type: { type: string, example: Bearer }
        expires_in: { type: integer, example: 900 }
        refresh_token: { type: string }

    AuthLogoutRequest:
      type: object
      properties:
        all: { type: boolean, default: false }

    MeResponse:
      type: object
      properties:
        user: { $ref: '#/components/schemas/User' }
        role:
          type: string
          enum: [tenant, owner, admin]
        fcm_tokens:
          type: array
          items: { type: string }

    ProfileUpdateRequest:
      type: object
      properties:
        name:
          type: string
          maxLength: 80
          example: "Ahmed Ali"
        phone_number:
          type: string
          pattern: '^09[0-9]{8}$'
          description: 'Libyan mobile number (10 digits starting with 09)'
          example: "0912345678"
        region:
          type: string
          maxLength: 100
          example: "Tripoli"
        current_password:
          type: string
          description: "Required when changing password"
          example: "oldpassword123"
        password:
          type: string
          minLength: 8
          description: "New password"
          example: "newpassword123"
        password_confirmation:
          type: string
          description: "Must match password"
          example: "newpassword123"

    # Properties
    PropertyListResponse:
      type: object
      properties:
        data:
          type: array
          items: { $ref: '#/components/schemas/PropertySummary' }
        next_cursor: { type: string, nullable: true }

    PropertyDetailResponse:
      $ref: '#/components/schemas/PropertyDetail'

    PropertyOwnerResponse:
      allOf:
        - $ref: '#/components/schemas/PropertyDetail'
        - type: object
          properties:
            statistics:
              type: object
              properties:
                bookings_count: { type: integer }
                reviews_count: { type: integer }
                avg_rating: { type: number, format: float, nullable: true }
                total_revenue: { type: number, format: float }
            version: { type: integer }
            created_at: { type: string, format: date-time }
            updated_at: { type: string, format: date-time }

    PropertyUpdateRequest:
      type: object
      description: |
        Update property request. All fields are optional (partial updates supported).
        Version is automatically incremented by the backend.
      properties:
        title:
          type: string
          maxLength: 200
          example: "Beautiful Villa in Tripoli"
        description:
          type: string
          maxLength: 5000
          example: "A stunning villa with modern amenities..."
        city:
          type: string
          maxLength: 80
          example: "Tripoli"
        type:
          type: string
          enum: [apartment, villa, chalet]
          example: "villa"
        price:
          type: number
          format: float
          minimum: 0
          example: 800.00
        location:
          type: object
          properties:
            latitude:
              type: number
              format: float
              minimum: -90
              maximum: 90
              example: 32.0679175
            longitude:
              type: number
              format: float
              minimum: -180
              maximum: 180
              example: 20.0850292
            map_url:
              type: string
              format: uri
              maxLength: 500
              nullable: true
              example: "https://www.google.com/maps?q=32.0679175,20.0850292"
        amenities:
          type: array
          items:
            type: string
            maxLength: 50
          example: ["wifi", "parking", "pool", "tv"]
        photos:
          type: array
          maxItems: 20
          items:
            type: string
            format: uri
            maxLength: 500
          description: Array of photo URLs (from /v1/upload endpoint)
          example: ["http://3.68.75.38/storage/properties/image1.jpg"]
        unavailable_dates:
          type: array
          items:
            type: string
            format: date
          description: Array of dates when property is unavailable
          example: ["2025-12-25", "2025-12-26"]

    # Bookings
    BookingCreateRequest:
      type: object
      required: [property_id, check_in, check_out, guests]
      properties:
        property_id: { type: string, format: uuid }
        check_in: { type: string, format: date }
        check_out: { type: string, format: date }
        guests: { type: integer, minimum: 1 }

    BookingCreateResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        status:
          type: string
          enum: [PENDING]
        total: { type: number, format: float }
        payment_window: { type: string, nullable: true }

    BookingListResponse:
      type: object
      properties:
        data:
          type: array
          items: { $ref: '#/components/schemas/Booking' }
        next_cursor: { type: string, nullable: true }

    OwnerDecisionRequest:
      type: object
      required: [decision]
      properties:
        decision:
          type: string
          enum: [ACCEPT, REJECT]
        reason:
          type: string
          nullable: true
          maxLength: 300

    OwnerDecisionResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        status:
          type: string
          enum: [ACCEPTED, REJECTED]
        payment_due_at: { type: string, format: date-time, nullable: true }

    # Payments
    MockPaymentRequest:
      type: object
      required: [booking_id]
      properties:
        booking_id: { type: string, format: uuid }

    MockPaymentResponse:
      type: object
      properties:
        booking_id: { type: string, format: uuid }
        status:
          type: string
          enum: [CONFIRMED]
        receipt_no: { type: string }
        paid_at: { type: string, format: date-time }

    # Moderation
    ProposalCreateRequest:
      oneOf:
        - type: object
          required: [type, payload]
          properties:
            type: { type: string, const: ADD }
            payload:
              type: object
              description: Property fields for ADD
              properties:
                location:
                  type: object
                  required: [latitude, longitude]
                  properties:
                    latitude: { type: number, format: float, minimum: -90, maximum: 90 }
                    longitude: { type: number, format: float, minimum: -180, maximum: 180 }
        - type: object
          required: [type, property_id, version, payload]
          properties:
            type: { type: string, const: EDIT }
            property_id: { type: string, format: uuid }
            version: { type: integer, minimum: 1 }
            payload:
              type: object
              description: Partial fields to update
              properties:
                location:
                  type: object
                  properties:
                    latitude: { type: number, format: float, minimum: -90, maximum: 90 }
                    longitude: { type: number, format: float, minimum: -180, maximum: 180 }
        - type: object
          required: [type, property_id, reason]
          properties:
            type: { type: string, const: DELETE }
            property_id: { type: string, format: uuid }
            reason: { type: string, minLength: 3 }

    ProposalUpdateRequest:
      oneOf:
        - type: object
          description: Update ADD proposal - all fields optional
          properties:
            payload:
              type: object
              description: Property fields to update (partial updates supported)
              properties:
                title: { type: string, maxLength: 200 }
                description: { type: string, maxLength: 5000 }
                city: { type: string, maxLength: 80 }
                type: { type: string, enum: [apartment, villa, chalet] }
                price: { type: number, format: float, minimum: 0 }
                location:
                  type: object
                  properties:
                    latitude: { type: number, format: float, minimum: -90, maximum: 90 }
                    longitude: { type: number, format: float, minimum: -180, maximum: 180 }
                    map_url: { type: string, format: uri, maxLength: 500, nullable: true }
                amenities:
                  type: array
                  items: { type: string, maxLength: 50 }
                photos:
                  type: array
                  maxItems: 20
                  items: { type: string, format: uri, maxLength: 500 }
        - type: object
          description: Update EDIT proposal - all fields optional
          properties:
            property_id: { type: string, format: uuid }
            version: { type: integer, minimum: 1 }
            payload:
              type: object
              description: Partial fields to update
              properties:
                title: { type: string, maxLength: 200 }
                description: { type: string, maxLength: 5000 }
                city: { type: string, maxLength: 80 }
                type: { type: string, enum: [apartment, villa, chalet] }
                price: { type: number, format: float, minimum: 0 }
                location:
                  type: object
                  properties:
                    latitude: { type: number, format: float, minimum: -90, maximum: 90 }
                    longitude: { type: number, format: float, minimum: -180, maximum: 180 }
                    map_url: { type: string, format: uri, maxLength: 500, nullable: true }
                amenities:
                  type: array
                  items: { type: string, maxLength: 50 }
                photos:
                  type: array
                  maxItems: 20
                  items: { type: string, format: uri, maxLength: 500 }
                unavailable_dates:
                  type: array
                  items: { type: string, format: date }
        - type: object
          description: Update DELETE proposal - all fields optional
          properties:
            property_id: { type: string, format: uuid }
            reason: { type: string, minLength: 3 }

    ProposalCreateResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        status:
          type: string
          enum: [PENDING]

    ProposalListResponse:
      type: object
      properties:
        data:
          type: array
          items: { $ref: '#/components/schemas/Proposal' }
        next_cursor: { type: string, nullable: true }

    ProposalListAdminResponse:
      allOf:
        - $ref: '#/components/schemas/ProposalListResponse'
        - type: object
          properties:
            # Diff may be computed on the server for EDIT proposals
            diff:
              type: object
              additionalProperties: true
              nullable: true

    ProposalReviewRequest:
      type: object
      required: [decision]
      properties:
        decision:
          type: string
          enum: [APPROVED, REJECTED]
        notes:
          type: string
          nullable: true
          maxLength: 500

    ProposalReviewResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        status:
          type: string
          enum: [APPROVED, REJECTED]
        applied_at: { type: string, format: date-time, nullable: true }

    # Reviews
    ReviewCreateRequest:
      type: object
      required: [rating]
      properties:
        rating: { type: integer, minimum: 1, maximum: 5 }
        comment: { type: string, maxLength: 500, nullable: true }

    ReviewCreateResponse:
      $ref: '#/components/schemas/Review'

    ReviewListResponse:
      type: object
      properties:
        data:
          type: array
          items: { $ref: '#/components/schemas/Review' }
        next_cursor: { type: string, nullable: true }

    # FCM
    FcmTokenStoreRequest:
      type: object
      required: [token, platform]
      properties:
        token: { type: string, minLength: 10 }
        platform:
          type: string
          enum: [android, ios, web]

    FcmTokenStoreResponse:
      type: object
      properties:
        id: { type: string, format: uuid }
        token: { type: string }

    FileUploadResponse:
      type: object
      required: [url]
      properties:
        url:
          type: string
          format: uri
          description: Public URL to access the uploaded image
          example: "https://api.maawa.example/storage/proposals/1234567890_abc123_my-image.jpg"
        id:
          type: string
          description: Unique identifier for the uploaded file (filename without extension)
          example: "1234567890_abc123_my-image"
        filename:
          type: string
          description: Original filename of the uploaded file
          example: "my-image.jpg"

  ########################
  # Standard Responses
  ########################
  responses:
    Unauthorized:
      description: Unauthorized
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
          examples:
            token_expired:
              value:
                type: "about:blank"
                title: "Unauthorized"
                status: 401
                detail: "token_expired"

    Forbidden:
      description: Forbidden
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }

    NotFound:
      description: Not Found
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }

    Conflict:
      description: Conflict
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }
          examples:
            date_range_unavailable:
              summary: Date range unavailable
              value:
                type: "about:blank"
                title: "Conflict"
                status: 409
                detail: "date_range_unavailable"

    Gone:
      description: Gone
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }

    ValidationError:
      description: Validation Error
      content:
        application/problem+json:
          schema: { $ref: '#/components/schemas/Problem' }

